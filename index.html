<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>麻雀点数計算</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;600;700&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:        #0d1117;
      --panel:     #161d2b;
      --panel2:    #1c2638;
      --border:    #2a3a52;
      --gold:      #c8a96e;
      --gold2:     #e8cc90;
      --red:       #e05a5a;
      --text:      #d4dbe8;
      --text-dim:  #7a8ba0;
      --accent:    #3a5a8a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Noto Sans JP', sans-serif;
      font-weight: 300;
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse at 20% 20%, rgba(58,90,138,0.15) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 80%, rgba(200,169,110,0.07) 0%, transparent 60%);
    }

    header {
      text-align: center;
      padding: 36px 20px 20px;
      border-bottom: 1px solid var(--border);
    }

    header h1 {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.15em;
    }

    header p {
      color: var(--text-dim);
      font-size: 0.78rem;
      margin-top: 4px;
      letter-spacing: 0.1em;
    }

    .container {
      max-width: 760px;
      margin: 0 auto;
      padding: 24px 16px 60px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* ---- Section Card ---- */
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .card-header {
      background: var(--panel2);
      border-bottom: 1px solid var(--border);
      padding: 10px 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-header .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--gold);
      opacity: 0.7;
    }

    .card-header h2 {
      font-family: 'Noto Serif JP', serif;
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--gold);
      letter-spacing: 0.12em;
    }

    .card-body {
      padding: 16px 18px;
    }

    /* ---- 門前/食い ---- */
    .menzen-row {
      display: flex;
      gap: 10px;
    }

    .radio-btn {
      flex: 1;
      position: relative;
    }

    .radio-btn input {
      position: absolute;
      opacity: 0;
      width: 0;
    }

    .radio-btn label {
      display: block;
      text-align: center;
      padding: 9px;
      border-radius: 6px;
      border: 1px solid var(--border);
      cursor: pointer;
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      color: var(--text-dim);
      transition: all 0.2s;
      background: var(--bg);
    }

    .radio-btn input:checked + label {
      border-color: var(--gold);
      color: var(--gold);
      background: rgba(200,169,110,0.08);
    }

    /* ---- 役グリッド ---- */
    .yaku-section {
      margin-bottom: 14px;
    }

    .yaku-section-title {
      font-size: 0.72rem;
      color: var(--gold);
      letter-spacing: 0.15em;
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(200,169,110,0.2);
    }

    .yaku-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .yaku-check {
      position: relative;
    }

    .yaku-check input {
      position: absolute;
      opacity: 0;
      width: 0;
    }

    .yaku-check label {
      display: inline-block;
      padding: 5px 11px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--bg);
      font-size: 0.82rem;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.15s;
      user-select: none;
    }

    .yaku-check input:checked + label {
      border-color: var(--gold);
      color: var(--gold2);
      background: rgba(200,169,110,0.1);
    }

    .yaku-check input:disabled + label {
      opacity: 0.25;
      cursor: not-allowed;
    }

    /* 役満は赤 */
    .yakuman .yaku-check input:checked + label {
      border-color: var(--red);
      color: #f08080;
      background: rgba(224,90,90,0.1);
    }

    /* ---- 翻数表示バー ---- */
    .han-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 10px 16px;
      margin-top: 14px;
    }

    .han-bar .label {
      font-size: 0.78rem;
      color: var(--text-dim);
      letter-spacing: 0.1em;
    }

    .han-bar .value {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.1rem;
      color: var(--gold2);
      font-weight: 600;
    }

    .han-bar .yaku-names {
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-top: 2px;
    }

    /* ---- 入力フォーム ---- */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 480px) {
      .form-grid { grid-template-columns: 1fr; }
    }

    .form-item label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-dim);
      letter-spacing: 0.1em;
      margin-bottom: 5px;
    }

    .form-item input[type="number"] {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 0.95rem;
      padding: 9px 12px;
      outline: none;
      transition: border-color 0.2s;
    }

    .form-item input[type="number"]:focus {
      border-color: var(--gold);
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .toggle-group {
      flex: 1;
      display: flex;
      gap: 6px;
    }

    /* ---- 計算ボタン ---- */
    .calc-btn {
      width: 100%;
      margin-top: 16px;
      padding: 13px;
      background: linear-gradient(135deg, #b8943e, #c8a96e, #b8943e);
      border: none;
      border-radius: 8px;
      color: #0d1117;
      font-family: 'Noto Serif JP', serif;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.2em;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
    }

    .calc-btn:hover { opacity: 0.9; }
    .calc-btn:active { transform: scale(0.98); }

    /* ---- 結果表示 ---- */
    .result-box {
      margin-top: 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      min-height: 64px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .result-main {
      font-family: 'Noto Serif JP', serif;
      font-size: 1.7rem;
      font-weight: 700;
      color: var(--gold2);
      letter-spacing: 0.05em;
      text-align: center;
    }

    .result-sub {
      font-size: 0.82rem;
      color: var(--text-dim);
      margin-top: 5px;
      text-align: center;
    }

    .result-placeholder {
      color: var(--text-dim);
      font-size: 0.85rem;
      letter-spacing: 0.05em;
    }

    .result-error {
      color: var(--red);
      font-size: 0.9rem;
    }

    /* ========== レイアウト（手牌＋計算・副露エリア） ========== */
    .app-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 60px;
      align-items: flex-start;
    }

    .main-content {
      flex: 1;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .meld-sidebar {
      width: 280px;
      flex-shrink: 0;
    }

    @media (max-width: 700px) {
      .app-wrap { flex-direction: column; padding: 16px 12px 40px; }
      .meld-sidebar { width: 100%; }
    }

    /* ========== 手牌選択（アコーディオン） ========== */
    .accordion-header {
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
      color: var(--gold2);
      letter-spacing: 0.08em;
      user-select: none;
      transition: background 0.2s;
    }

    .accordion-header:hover { background: var(--panel); }
    .accordion-header .arrow { transition: transform 0.25s; }
    .accordion-header.open .arrow { transform: rotate(180deg); }

    .accordion-body {
      display: none;
      padding: 12px 0 4px;
      border-bottom: 1px solid var(--border);
    }

    .accordion-body.open { display: block; }

    .accordion-item { margin-bottom: 4px; }
    .accordion-item:last-child { margin-bottom: 0; }

    .tile-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tile-btn {
      width: 44px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #2a3548;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1.6rem;
      cursor: pointer;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      color: #e8eef5;
      filter: brightness(1.15);
    }

    .tile-btn:hover {
      border-color: var(--gold);
      background: rgba(200,169,110,0.2);
      filter: brightness(1.25);
    }

    .tile-btn:active { transform: scale(0.96); }

    @media (max-width: 480px) {
      .tile-btn { width: 40px; height: 48px; font-size: 1.45rem; }
    }

    /* ========== 手牌エリア ========== */
    .hand-area-wrap {
      overflow-x: auto;
      margin-bottom: 4px;
    }

    .hand-area {
      min-height: 72px;
      min-width: 748px;
      padding: 14px;
      background: var(--bg);
      border: 1px dashed var(--border);
      border-radius: 8px;
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      align-items: center;
      align-content: flex-start;
    }

    .hand-tile {
      width: 44px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--panel2);
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 1.6rem;
      cursor: pointer;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }

    .hand-tile:hover { border-color: var(--gold); }
    .hand-tile.selected {
      border-color: var(--gold);
      background: rgba(200,169,110,0.25);
      box-shadow: 0 0 0 2px var(--gold);
    }

    .hand-tile.dragging {
      opacity: 0.6;
      cursor: grabbing;
    }

    .hand-tile.drag-over {
      border-color: var(--gold);
      background: rgba(200,169,110,0.15);
    }

    @media (max-width: 480px) {
      .hand-tile { width: 40px; height: 48px; font-size: 1.45rem; }
      .hand-area { min-width: 692px; }
    }

    .furo-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .furo-btn {
      padding: 10px 18px;
      border-radius: 6px;
      border: 1px solid var(--gold);
      background: rgba(200,169,110,0.12);
      color: var(--gold2);
      font-size: 0.88rem;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.2s;
    }

    .furo-btn:hover { background: rgba(200,169,110,0.22); }
    .furo-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .furo-warning {
      margin-top: 10px;
      padding: 10px 14px;
      background: rgba(224,90,90,0.12);
      border: 1px solid var(--red);
      border-radius: 6px;
      color: #f08080;
      font-size: 0.85rem;
      letter-spacing: 0.04em;
    }

    /* ========== 副露エリア（右サイド） ========== */
    .meld-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      position: sticky;
      top: 20px;
    }

    .meld-card .card-header { padding: 10px 14px; }
    .meld-card .card-body { padding: 12px 14px; }

    .meld-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .meld-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px;
      padding: 8px 10px;
      background: var(--bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .meld-tile {
      width: 38px;
      height: 46px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 1.4rem;
      cursor: pointer;
      transition: transform 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .meld-tile.called-from-0 { transform: rotate(-90deg); }   /* 上家 */
    .meld-tile.called-from-1 { transform: none; }            /* 対面 */
    .meld-tile.called-from-2 { transform: rotate(90deg); }   /* 下家 */

    .meld-tile-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      min-width: 46px;
      min-height: 50px;
    }

    .meld-tile-wrap .call-label {
      font-size: 0.55rem;
      color: var(--gold);
      margin-top: 2px;
      white-space: nowrap;
    }

    .meld-placeholder {
      color: var(--text-dim);
      font-size: 0.8rem;
      text-align: center;
      padding: 20px 10px;
      letter-spacing: 0.05em;
    }

    /* ========== 手動役選択モーダル ========== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      box-sizing: border-box;
    }

    .modal-box {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-width: 420px;
      width: 100%;
      padding: 24px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }

    .modal-box h3 {
      font-family: 'Noto Serif JP', serif;
      font-size: 1rem;
      color: var(--gold);
      letter-spacing: 0.12em;
      margin-bottom: 8px;
    }

    .modal-desc {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-bottom: 18px;
      line-height: 1.5;
    }

    .modal-yaku-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      margin-bottom: 20px;
    }

    .modal-yaku-grid label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg);
      font-size: 0.85rem;
      color: var(--text);
      cursor: pointer;
      user-select: none;
      transition: all 0.15s;
    }

    .modal-yaku-grid label:hover { border-color: var(--gold); }
    .modal-yaku-grid label:has(input:checked) { border-color: var(--gold); color: var(--gold2); background: rgba(200,169,110,0.1); }

    .modal-yaku-grid input { margin: 0; }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn-cancel {
      padding: 10px 20px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-dim);
      font-size: 0.88rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn-cancel:hover { color: var(--text); border-color: var(--text-dim); }

    .modal-btn-ok {
      padding: 10px 24px;
      border-radius: 6px;
      border: none;
      background: linear-gradient(135deg, #b8943e, #c8a96e);
      color: #0d1117;
      font-family: 'Noto Serif JP', serif;
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .modal-btn-ok:hover { opacity: 0.9; }

    .modal-yaku-grid label:has(input:disabled) {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
  </style>
</head>
<body>

<header>
  <h1>麻 雀 点 数 計 算</h1>
  <p>雀魂 段位戦ルール対応</p>
</header>

<div class="app-wrap">
  <div class="main-content">

  <!-- 手牌選択 -->
  <div class="card">
    <div class="card-header"><div class="dot"></div><h2>手 牌 選 択</h2></div>
    <div class="card-body">
      <div class="accordion" id="tile_accordion">
        <div class="accordion-item">
          <div class="accordion-header" data-target="manzu">萬子 <span class="arrow">▼</span></div>
          <div class="accordion-body" id="manzu">
            <div class="tile-grid" id="grid_manzu"></div>
          </div>
        </div>
        <div class="accordion-item">
          <div class="accordion-header" data-target="pinzu">筒子 <span class="arrow">▼</span></div>
          <div class="accordion-body" id="pinzu">
            <div class="tile-grid" id="grid_pinzu"></div>
          </div>
        </div>
        <div class="accordion-item">
          <div class="accordion-header" data-target="souzu">索子 <span class="arrow">▼</span></div>
          <div class="accordion-body" id="souzu">
            <div class="tile-grid" id="grid_souzu"></div>
          </div>
        </div>
        <div class="accordion-item">
          <div class="accordion-header" data-target="jihai">字牌 <span class="arrow">▼</span></div>
          <div class="accordion-body" id="jihai">
            <div class="tile-grid" id="grid_jihai"></div>
          </div>
        </div>
      </div>
      <div style="margin-top:14px;">
        <div class="yaku-section-title">手牌エリア（最大14枚）</div>
        <p style="font-size:0.72rem;color:var(--text-dim);margin-bottom:6px;">クリックで選択（副露用）・ダブルクリックで1枚削除・ドラッグで並べ替え</p>
        <div class="hand-area-wrap">
          <div class="hand-area" id="hand_area"></div>
        </div>
        <div class="furo-actions">
          <button type="button" class="furo-btn" id="btn_furo">副露する</button>
          <button type="button" class="furo-btn" id="btn_clear_sel">選択解除</button>
          <button type="button" class="furo-btn" id="btn_remove_sel">選択牌を削除</button>
          <button type="button" class="furo-btn" id="btn_clear_all">すべて解除</button>
        </div>
        <div id="furo_warning" class="furo-warning" style="display:none;">副露牌を正しく選択してください。順子（例：一二三）・刻子（同じ牌3枚）・槓子（同じ牌4枚）のいずれかになるように選んでください。</div>
      </div>
    </div>
  </div>

<div class="container" style="max-width:none;padding:0;">

  <!-- 点数計算 -->
  <div class="card">
    <div class="card-header"><div class="dot"></div><h2>点 数 計 算</h2></div>
    <div class="card-body">

      <div class="form-grid">
        <div class="form-item">
          <label>場風（役判定用）</label>
          <select id="bakaze" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:9px 12px;font-size:0.95rem;">
            <option value="0">東</option>
            <option value="1">南</option>
            <option value="2">西</option>
            <option value="3">北</option>
          </select>
        </div>
        <div class="form-item">
          <label>自風（役判定用）</label>
          <select id="jikaze" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:9px 12px;font-size:0.95rem;">
            <option value="0">東</option>
            <option value="1">南</option>
            <option value="2">西</option>
            <option value="3">北</option>
          </select>
        </div>
        <div class="form-item">
          <label>翻数（手牌から自動）</label>
          <input type="number" id="han" placeholder="手牌を14枚で計算" min="1" readonly style="background:var(--panel2);">
        </div>
        <div class="form-item">
          <label>符（手牌から自動）</label>
          <input type="number" id="fu" placeholder="手牌を14枚で計算" min="20" readonly style="background:var(--panel2);">
        </div>
        <div class="form-item">
          <label>本場</label>
          <input type="number" id="honba" value="0" min="0">
        </div>
        <div class="form-item">
          <label>場のリーチ棒</label>
          <input type="number" id="riichi_ba" value="0" min="0">
        </div>
        <div class="form-item">
          <label>持ち越し供託</label>
          <input type="number" id="riichi_kuyaku" value="0" min="0">
        </div>
      </div>

      <div class="form-row" style="margin-top:16px;">
        <div class="toggle-group">
          <div class="radio-btn">
            <input type="radio" name="oya" id="r_ko" value="ko" checked>
            <label for="r_ko">子</label>
          </div>
          <div class="radio-btn">
            <input type="radio" name="oya" id="r_oya" value="oya">
            <label for="r_oya">親</label>
          </div>
        </div>
        <div class="toggle-group">
          <div class="radio-btn">
            <input type="radio" name="agari" id="r_ron" value="ron" checked>
            <label for="r_ron">ロン</label>
          </div>
          <div class="radio-btn">
            <input type="radio" name="agari" id="r_tsumo" value="tsumo">
            <label for="r_tsumo">ツモ</label>
          </div>
        </div>
      </div>

      <button class="calc-btn" onclick="keisan()">計 算 す る</button>

      <div class="han-bar" id="detected_yaku_bar" style="display:none; margin-top:12px;">
        <div>
          <div class="label">検出された役</div>
          <div class="yaku-names" id="yaku_names">—</div>
        </div>
        <div class="value" id="han_display">0翻</div>
      </div>

      <div class="result-box" id="result_box">
        <span class="result-placeholder">結果がここに表示されます</span>
      </div>

    </div>
  </div>

  </div>
  </div>

  <!-- 副露エリア（右側） -->
  <aside class="meld-sidebar">
    <div class="meld-card">
      <div class="card-header"><div class="dot"></div><h2>副 露 エ リア</h2></div>
      <div class="card-body">
        <div class="meld-list" id="meld_list"></div>
        <div class="meld-placeholder" id="meld_placeholder">手牌で牌を選択し「副露する」でここに移動します。<br>牌をクリックで上家・対面・下家を切り替え。</div>
      </div>
    </div>
  </aside>

</div>

<!-- 手動役選択モーダル -->
<div id="yaku_modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this) closeYakuModal();">
  <div class="modal-box" onclick="event.stopPropagation()">
    <h3>手牌からは判定できない役</h3>
    <p class="modal-desc">該当する役にチェックを入れて「点数計算」を押してください。</p>
    <div class="modal-yaku-grid">
      <label><input type="checkbox" id="ex_riichi"> 立直（1翻）</label>
      <label><input type="checkbox" id="ex_daburi"> ダブル立直（2翻）</label>
      <label><input type="checkbox" id="ex_ippatsu"> 一発（1翻）</label>
      <label><input type="checkbox" id="ex_tsumo"> 門前清自摸和（1翻）</label>
      <label><input type="checkbox" id="ex_tenho"> 天和（役満）</label>
      <label><input type="checkbox" id="ex_chiho"> 地和（役満）</label>
    </div>
    <div class="modal-actions">
      <button type="button" class="modal-btn-cancel" id="modal_cancel">キャンセル</button>
      <button type="button" class="modal-btn-ok" id="modal_ok">点数計算</button>
    </div>
  </div>
</div>

<script>
  // ========== 牌データ（Unicode） ==========
  var TILES = {
    manzu: [0x1F007,0x1F008,0x1F009,0x1F00A,0x1F00B,0x1F00C,0x1F00D,0x1F00E,0x1F00F],
    pinzu: [0x1F019,0x1F01A,0x1F01B,0x1F01C,0x1F01D,0x1F01E,0x1F01F,0x1F020,0x1F021],
    souzu: [0x1F010,0x1F011,0x1F012,0x1F013,0x1F014,0x1F015,0x1F016,0x1F017,0x1F018],
    jihai: [0x1F000,0x1F001,0x1F002,0x1F003,0x1F004,0x1F005,0x1F006]
  };
  var JIHAI_NAMES = ['東','南','西','北','中','発','白'];

  function renderTilePicker() {
    ['manzu','pinzu','souzu'].forEach(function(cat) {
      var grid = document.getElementById('grid_' + cat);
      if (!grid) return;
      grid.innerHTML = '';
      var arr = TILES[cat];
      for (var i = 0; i < arr.length; i++) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'tile-btn';
        btn.textContent = String.fromCodePoint(arr[i]);
        btn.dataset.cat = cat;
        btn.dataset.num = i + 1;
        btn.dataset.unicode = arr[i];
        btn.onclick = function() { addToHand(this.dataset.cat, parseInt(this.dataset.num, 10), parseInt(this.dataset.unicode, 10)); };
        grid.appendChild(btn);
      }
    });
    var jg = document.getElementById('grid_jihai');
    if (jg) {
      jg.innerHTML = '';
      for (var j = 0; j < TILES.jihai.length; j++) {
        var b = document.createElement('button');
        b.type = 'button';
        b.className = 'tile-btn';
        b.textContent = String.fromCodePoint(TILES.jihai[j]);
        b.dataset.cat = 'jihai';
        b.dataset.num = String(j + 1);
        b.dataset.unicode = TILES.jihai[j];
        b.onclick = function() { addToHand('jihai', parseInt(this.dataset.num, 10), parseInt(this.dataset.unicode, 10)); };
        jg.appendChild(b);
      }
    }
  }

  var handTiles = [];
  var handTileId = 0;
  var selectedHandIndices = new Set();
  var meldGroups = [];

  function tileIndexForMeld(cat, num) {
    if (cat === 'manzu') return num - 1;
    if (cat === 'pinzu') return 9 + num - 1;
    if (cat === 'souzu') return 18 + num - 1;
    return 27 + num - 1;
  }

  function getSelectedTiles() {
    return Array.from(selectedHandIndices).sort(function(a,b){ return a - b; }).map(function(i) { return handTiles[i]; });
  }

  function isValidMeld(tiles) {
    if (!tiles || (tiles.length !== 3 && tiles.length !== 4)) return false;
    var idx = tiles.map(function(t) { return tileIndexForMeld(t.cat, t.num); });
    if (tiles.length === 3) {
      idx.sort(function(a,b){ return a - b; });
      if (idx[0] === idx[1] && idx[1] === idx[2]) return true;
      if (idx[0] >= 27) return false;
      var suit = Math.floor(idx[0] / 9);
      if (Math.floor(idx[1] / 9) !== suit || Math.floor(idx[2] / 9) !== suit) return false;
      if (idx[0] + 1 === idx[1] && idx[1] + 1 === idx[2]) return true;
      return false;
    }
    if (tiles.length === 4) {
      idx.sort(function(a,b){ return a - b; });
      if (idx[0] === idx[1] && idx[1] === idx[2] && idx[2] === idx[3]) return true;
      return false;
    }
    return false;
  }

  function addToHand(cat, num, unicode) {
    if (handTiles.length >= 14) return;
    var id = ++handTileId;
    var name = (cat === 'jihai') ? JIHAI_NAMES[num - 1] : (cat === 'manzu' ? num + '萬' : cat === 'pinzu' ? num + '筒' : num + '索');
    handTiles.push({ id: id, cat: cat, num: num, unicode: unicode, name: name });
    renderHand();
  }

  function removeFromHand(index) {
    handTiles.splice(index, 1);
    selectedHandIndices.clear();
    renderHand();
  }

  function toggleHandSelection(index) {
    if (selectedHandIndices.has(index)) selectedHandIndices.delete(index);
    else selectedHandIndices.add(index);
    renderHand();
  }

  function moveHandTile(fromIndex, toIndex) {
    if (fromIndex === toIndex) return;
    var tile = handTiles.splice(fromIndex, 1)[0];
    var newTo = (fromIndex < toIndex) ? toIndex - 1 : toIndex;
    handTiles.splice(newTo, 0, tile);
    selectedHandIndices.clear();
    renderHand();
  }

  function renderHand() {
    var area = document.getElementById('hand_area');
    area.innerHTML = '';
    handTiles.forEach(function(t, i) {
      var el = document.createElement('button');
      el.type = 'button';
      el.className = 'hand-tile' + (selectedHandIndices.has(i) ? ' selected' : '');
      el.textContent = String.fromCodePoint(t.unicode);
      el.dataset.index = i;
      el.draggable = true;
      el.onclick = function(ev) {
        ev.preventDefault();
        var idx = parseInt(this.dataset.index, 10);
        toggleHandSelection(idx);
      };
      el.ondblclick = function(ev) {
        ev.preventDefault();
        var idx = parseInt(this.dataset.index, 10);
        selectedHandIndices.delete(idx);
        removeFromHand(idx);
      };
      el.ondragstart = function(ev) {
        ev.dataTransfer.setData('text/plain', String(this.dataset.index));
        ev.dataTransfer.effectAllowed = 'move';
        this.classList.add('dragging');
      };
      el.ondragend = function() {
        this.classList.remove('dragging');
        area.querySelectorAll('.hand-tile.drag-over').forEach(function(e) { e.classList.remove('drag-over'); });
      };
      el.ondragover = function(ev) {
        ev.preventDefault();
        ev.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
      };
      el.ondragleave = function() {
        this.classList.remove('drag-over');
      };
      el.ondrop = function(ev) {
        ev.preventDefault();
        this.classList.remove('drag-over');
        var fromIndex = parseInt(ev.dataTransfer.getData('text/plain'), 10);
        var toIndex = parseInt(this.dataset.index, 10);
        moveHandTile(fromIndex, toIndex);
      };
      area.appendChild(el);
    });
    var selCount = selectedHandIndices.size;
    var tiles = getSelectedTiles();
    var valid = (selCount === 3 || selCount === 4) && isValidMeld(tiles);
    document.getElementById('btn_furo').disabled = !valid;
    document.getElementById('furo_warning').style.display = 'none';
  }

  document.getElementById('btn_clear_sel').onclick = function() {
    selectedHandIndices.clear();
    renderHand();
  };

  document.getElementById('btn_clear_all').onclick = function() {
    handTiles.length = 0;
    selectedHandIndices.clear();
    renderHand();
  };

  document.getElementById('btn_remove_sel').onclick = function() {
    if (selectedHandIndices.size === 0) return;
    var indices = Array.from(selectedHandIndices).sort(function(a,b){ return b - a; });
    indices.forEach(function(i) { handTiles.splice(i, 1); });
    selectedHandIndices.clear();
    renderHand();
  };

  document.getElementById('btn_furo').onclick = function() {
    var indices = Array.from(selectedHandIndices).sort(function(a,b){ return a - b; });
    var tiles = indices.map(function(i) { return Object.assign({}, handTiles[i]); });
    if (!isValidMeld(tiles)) {
      document.getElementById('furo_warning').style.display = 'block';
      return;
    }
    document.getElementById('furo_warning').style.display = 'none';
    meldGroups.push({ tiles: tiles, calledIndex: 0, calledFrom: 0 });
    for (var i = indices.length - 1; i >= 0; i--) handTiles.splice(indices[i], 1);
    selectedHandIndices.clear();
    renderHand();
    renderMelds();
  };

  var CALL_LABELS = ['上家','対面','下家'];

  function renderMelds() {
    var list = document.getElementById('meld_list');
    var placeholder = document.getElementById('meld_placeholder');
    list.innerHTML = '';
    if (meldGroups.length === 0) {
      placeholder.style.display = 'block';
      return;
    }
    placeholder.style.display = 'none';
    meldGroups.forEach(function(group, gIdx) {
      var wrap = document.createElement('div');
      wrap.className = 'meld-group';
      group.tiles.forEach(function(tile, tIdx) {
        var tw = document.createElement('div');
        tw.className = 'meld-tile-wrap';
        var span = document.createElement('span');
        var isCalled = tIdx === group.calledIndex;
        span.className = 'meld-tile' + (isCalled ? ' called-from-' + group.calledFrom : '');
        span.textContent = String.fromCodePoint(tile.unicode);
        span.dataset.g = gIdx;
        span.dataset.t = tIdx;
        span.onclick = function() {
          var g = parseInt(this.dataset.g, 10);
          var t = parseInt(this.dataset.t, 10);
          if (meldGroups[g].calledIndex !== t) {
            meldGroups[g].calledIndex = t;
            meldGroups[g].calledFrom = 0;
          } else {
            meldGroups[g].calledFrom = (meldGroups[g].calledFrom + 1) % 3;
          }
          renderMelds();
        };
        tw.appendChild(span);
        if (isCalled) {
          var lbl = document.createElement('span');
          lbl.className = 'call-label';
          lbl.textContent = CALL_LABELS[group.calledFrom];
          tw.appendChild(lbl);
        }
        wrap.appendChild(tw);
      });
      list.appendChild(wrap);
    });
  }

  document.querySelectorAll('#tile_accordion .accordion-header').forEach(function(h) {
    h.onclick = function() {
      var target = document.getElementById(this.dataset.target);
      var isOpen = target.classList.contains('open');
      document.querySelectorAll('#tile_accordion .accordion-body').forEach(function(b) { b.classList.remove('open'); });
      document.querySelectorAll('#tile_accordion .accordion-header').forEach(function(h2) { h2.classList.remove('open'); });
      if (!isOpen) { target.classList.add('open'); this.classList.add('open'); }
    };
  });
  document.querySelector('#tile_accordion .accordion-header').click();

  renderTilePicker();
  renderHand();
  renderMelds();

  // ========== 手牌から役・符・翻の自動判定 ==========
  function tileToIndex(cat, num) {
    if (cat === 'manzu') return num - 1;
    if (cat === 'pinzu') return 9 + num - 1;
    if (cat === 'souzu') return 18 + num - 1;
    return 27 + num - 1;
  }

  function buildCounts() {
    var c = new Array(34);
    for (var i = 0; i < 34; i++) c[i] = 0;
    handTiles.forEach(function(t) {
      var idx = tileToIndex(t.cat, t.num);
      c[idx]++;
    });
    meldGroups.forEach(function(g) {
      g.tiles.forEach(function(t) {
        var idx = tileToIndex(t.cat, t.num);
        c[idx]++;
      });
    });
    return c;
  }

  var KOKUSHI_IDS = [0,8,9,17,18,26,27,28,29,30,31,32,33];
  function isKokushi(c) {
    var dup = 0;
    for (var i = 0; i < KOKUSHI_IDS.length; i++) {
      var n = c[KOKUSHI_IDS[i]];
      if (n === 0) return false;
      if (n >= 2) dup++;
    }
    return dup >= 1;
  }

  function isChiitoitsu(c) {
    var pairs = 0;
    for (var i = 0; i < 34; i++) {
      if (c[i] === 2) pairs++;
      else if (c[i] !== 0) return false;
    }
    return pairs === 7;
  }

  function removeMeld(c, meld) {
    for (var i = 0; i < meld.length; i++) c[meld[i]]--;
  }
  function addMeld(c, meld) {
    for (var i = 0; i < meld.length; i++) c[meld[i]]++;
  }

  function findMelds(c, out) {
    if (out.length === 4) return true;
    for (var i = 0; i < 34; i++) {
      if (c[i] >= 3) {
        removeMeld(c, [i,i,i]);
        out.push({ type: 'koutsu', tile: i });
        if (findMelds(c, out)) return true;
        addMeld(c, [i,i,i]);
        out.pop();
      }
    }
    for (var suit = 0; suit < 3; suit++) {
      var base = suit * 9;
      for (var n = 0; n < 7; n++) {
        var a = base + n, b = base + n + 1, d = base + n + 2;
        if (c[a] >= 1 && c[b] >= 1 && c[d] >= 1) {
          removeMeld(c, [a,b,d]);
          out.push({ type: 'shuntsu', start: a });
          if (findMelds(c, out)) return true;
          addMeld(c, [a,b,d]);
          out.pop();
        }
      }
    }
    return false;
  }

  function findDecomposition(c) {
    for (var pair = 0; pair < 34; pair++) {
      if (c[pair] < 2) continue;
      c[pair] -= 2;
      var melds = [];
      if (findMelds(c, melds)) {
        c[pair] += 2;
        return { pair: pair, melds: melds };
      }
      c[pair] += 2;
    }
    return null;
  }

  function analyzeHand() {
    var totalTiles = handTiles.length;
    meldGroups.forEach(function(g) { totalTiles += g.tiles.length; });
    if (totalTiles !== 14) return { ok: false, error: '手牌は14枚にしてください（現在' + totalTiles + '枚）' };

    var counts = buildCounts();
    var openCount = 0;
    meldGroups.forEach(function(g) { openCount += g.tiles.length; });
    var menzen = (openCount === 0);

    var bakaze = parseInt(document.getElementById('bakaze').value, 10);
    var jikaze = parseInt(document.getElementById('jikaze').value, 10);
    var bakazeTile = 27 + bakaze;
    var jikazeTile = 27 + jikaze;

    var yakuList = [];
    var han = 0;
    var fu = 0;
    var isChitoi = false;
    var isKoku = false;
    var decomposition = null;

    if (isKokushi(counts)) {
      isKoku = true;
      yakuList.push({ name: '国士無双', han: 13 });
      han = 13;
      fu = 0;
    } else if (isChiitoitsu(counts)) {
      isChitoi = true;
      yakuList.push({ name: '七対子', han: 2 });
      han = 2;
      fu = 25;
    } else {
      decomposition = findDecomposition(counts.slice());
      if (!decomposition) return { ok: false, error: '和了形ではありません' };

      var pair = decomposition.pair;
      var melds = decomposition.melds;

      function isTerminalOrHonor(idx) {
        if (idx >= 27) return true;
        var r = idx % 9;
        return r === 0 || r === 8;
      }
      function isTerminal(idx) {
        if (idx >= 27) return false;
        var r = idx % 9;
        return r === 0 || r === 8;
      }
      function suitOf(idx) {
        if (idx < 9) return 0;
        if (idx < 18) return 1;
        if (idx < 27) return 2;
        return -1;
      }
      function numberInSuit(idx) {
        return idx % 9;
      }

      var allSimple = true;
      for (var i = 0; i < 34; i++) {
        if (counts[i] && isTerminalOrHonor(i)) { allSimple = false; break; }
      }
      if (allSimple) { yakuList.push({ name: '断幺九', han: menzen ? 1 : 1 }); han += 1; }

      var dragonTriplets = 0;
      var dragonPair = false;
      for (var i = 31; i <= 33; i++) {
        if (counts[i] >= 3) dragonTriplets++;
        if (pair === i && counts[i] >= 2) dragonPair = true;
      }
      if (counts[31] >= 3) { yakuList.push({ name: '白', han: 1 }); han += 1; }
      if (counts[32] >= 3) { yakuList.push({ name: '発', han: 1 }); han += 1; }
      if (counts[33] >= 3) { yakuList.push({ name: '中', han: 1 }); han += 1; }
      if (counts[bakazeTile] >= 3) { yakuList.push({ name: '場風', han: 1 }); han += 1; }
      if (counts[jikazeTile] >= 3) { yakuList.push({ name: '自風', han: 1 }); han += 1; }

      if (dragonTriplets === 3) { yakuList.push({ name: '大三元', han: 13 }); han = 13; }
      else if (dragonTriplets === 2 && dragonPair) { yakuList.push({ name: '小三元', han: 2 }); han += 2; }

      var windCount = 0;
      for (var w = 27; w <= 30; w++) {
        if (counts[w] >= 3) windCount++;
      }
      if (windCount >= 4) { yakuList.push({ name: '大四喜', han: 13 }); han = 13; }
      else if (windCount >= 3) { yakuList.push({ name: '小四喜', han: 13 }); han = Math.max(han, 13); }

      var allHonors = true;
      for (var i = 0; i < 27; i++) {
        if (counts[i] > 0) { allHonors = false; break; }
      }
      if (allHonors && han < 13) { yakuList.push({ name: '字一色', han: 13 }); han = 13; }

      var toitoi = true;
      for (var m = 0; m < melds.length; m++) {
        if (melds[m].type === 'shuntsu') { toitoi = false; break; }
      }
      if (toitoi) { yakuList.push({ name: '対々和', han: 2 }); han += 2; }

      var sanshoku = false;
      for (var num = 0; num <= 6; num++) {
        var has0 = false, has1 = false, has2 = false;
        for (var m = 0; m < melds.length; m++) {
          if (melds[m].type === 'shuntsu' && melds[m].start === num) has0 = true;
          if (melds[m].type === 'shuntsu' && melds[m].start === 9 + num) has1 = true;
          if (melds[m].type === 'shuntsu' && melds[m].start === 18 + num) has2 = true;
        }
        if (has0 && has1 && has2) { sanshoku = true; break; }
      }
      if (sanshoku) { yakuList.push({ name: '三色同順', han: menzen ? 2 : 1 }); han += (menzen ? 2 : 1); }

      var ittsu = false;
      for (var suit = 0; suit < 3; suit++) {
        var base = suit * 9;
        var has0 = false, has3 = false, has6 = false;
        for (var m = 0; m < melds.length; m++) {
          if (melds[m].type === 'shuntsu') {
            if (melds[m].start === base) has0 = true;
            if (melds[m].start === base + 3) has3 = true;
            if (melds[m].start === base + 6) has6 = true;
          }
        }
        if (has0 && has3 && has6) { ittsu = true; break; }
      }
      if (ittsu) { yakuList.push({ name: '一気通貫', han: menzen ? 2 : 1 }); han += (menzen ? 2 : 1); }

      var sanshokudou = false;
      for (var n = 0; n < 9; n++) {
        var k0 = false, k1 = false, k2 = false;
        melds.forEach(function(m) {
          if (m.type === 'koutsu' && m.tile === n) k0 = true;
          if (m.type === 'koutsu' && m.tile === 9 + n) k1 = true;
          if (m.type === 'koutsu' && m.tile === 18 + n) k2 = true;
        });
        if (k0 && k1 && k2) { sanshokudou = true; break; }
      }
      if (sanshokudou) { yakuList.push({ name: '三色同刻', han: 2 }); han += 2; }

      var chanta = true;
      for (var m = 0; m < melds.length; m++) {
        var mt = melds[m];
        if (mt.type === 'shuntsu') {
          var start = mt.start;
          if (!isTerminalOrHonor(start) && !isTerminalOrHonor(start+1) && !isTerminalOrHonor(start+2)) chanta = false;
        } else {
          if (!isTerminalOrHonor(mt.tile)) chanta = false;
        }
      }
      if (!isTerminalOrHonor(pair)) chanta = false;
      if (chanta) {
        var junchan = true;
        for (var m = 0; m < melds.length; m++) {
          var mt = melds[m];
          if (mt.type === 'koutsu' && mt.tile >= 27) junchan = false;
          if (mt.type === 'shuntsu' && (mt.start >= 27 || (mt.start+2) % 9 >= 27)) junchan = false;
        }
        if (pair >= 27) junchan = false;
        if (junchan) { yakuList.push({ name: '純全帯幺九', han: menzen ? 3 : 2 }); han += (menzen ? 3 : 2); }
        else { yakuList.push({ name: '混全帯幺九', han: menzen ? 2 : 1 }); han += (menzen ? 2 : 1); }
      }

      var suits = [false, false, false];
      for (var i = 0; i < 27; i++) {
        if (counts[i] > 0) suits[suitOf(i)] = true;
      }
      var suitCount = (suits[0]?1:0) + (suits[1]?1:0) + (suits[2]?1:0);
      var hasHonor = counts[27] || counts[28] || counts[29] || counts[30] || counts[31] || counts[32] || counts[33];
      if (suitCount === 1 && hasHonor) { yakuList.push({ name: '混一色', han: menzen ? 3 : 2 }); han += (menzen ? 3 : 2); }
      if (suitCount === 1 && !hasHonor) { yakuList.push({ name: '清一色', han: menzen ? 6 : 5 }); han += (menzen ? 6 : 5); }

      var allTerminal = true;
      for (var i = 0; i < 34; i++) {
        if (counts[i] > 0 && !isTerminal(i) && i < 27) { allTerminal = false; break; }
        if (counts[i] > 0 && i >= 27) { allTerminal = false; break; }
      }
      if (allTerminal && !allHonors) { yakuList.push({ name: '清老頭', han: 13 }); han = 13; }
      var honroto = true;
      for (var i = 0; i < 34; i++) {
        if (counts[i] > 0 && !isTerminalOrHonor(i)) { honroto = false; break; }
      }
      if (honroto && !allTerminal) { yakuList.push({ name: '混老頭', han: 2 }); han += 2; }

      var seqs = [];
      for (var m = 0; m < melds.length; m++) {
        if (melds[m].type === 'shuntsu') seqs.push(melds[m].start);
      }
      var seqCount = {};
      seqs.forEach(function(s) { seqCount[s] = (seqCount[s] || 0) + 1; });
      var iipeiko = 0;
      for (var k in seqCount) iipeiko += Math.floor((seqCount[k] || 0) / 2);
      if (iipeiko >= 2) { yakuList.push({ name: '二盃口', han: 3 }); han += 3; }
      else if (iipeiko >= 1) { yakuList.push({ name: '一盃口', han: 1 }); han += 1; }

      var shuntsuCount = 0;
      for (var m = 0; m < melds.length; m++) if (melds[m].type === 'shuntsu') shuntsuCount++;
      var pinfuPair = (pair < 27) || (pair >= 27 && pair <= 30 && pair !== bakazeTile && pair !== jikazeTile);
      var noKoutsu = true;
      for (var m = 0; m < melds.length; m++) if (melds[m].type === 'koutsu') noKoutsu = false;
      if (shuntsuCount === 4 && pinfuPair && noKoutsu && menzen && han < 13) {
        yakuList.push({ name: '平和', han: 1 }); han += 1;
      }

      var ankouCount = 0;
      if (menzen) {
        for (var m = 0; m < melds.length; m++) {
          if (melds[m].type === 'koutsu') ankouCount++;
        }
      }
      if (ankouCount >= 4) { yakuList.push({ name: '四暗刻', han: 13 }); han = 13; }
      else if (ankouCount >= 3) { yakuList.push({ name: '三暗刻', han: 2 }); han += 2; }

      fu = calcFu(decomposition, menzen);
    }

    return {
      ok: true,
      han: han,
      fu: fu,
      yakuList: yakuList,
      isChiitoitsu: isChitoi,
      isKokushi: isKoku
    };
  }

  function calcFu(dec, menzen) {
    var agari = document.querySelector('input[name="agari"]:checked').value;
    var base = 20;
    if (agari === 'tsumo') base += 2;
    if (menzen && agari === 'ron') base += 10;

    var pair = dec.pair;
    var pairFu = 0;
    if (pair >= 27 && pair <= 30) {
      var bakaze = parseInt(document.getElementById('bakaze').value, 10);
      var jikaze = parseInt(document.getElementById('jikaze').value, 10);
      if (pair === 27 + bakaze || pair === 27 + jikaze) pairFu = 2;
    }
    if (pair >= 31 && pair <= 33) pairFu = 2;
    base += pairFu * 2;

    var anko = 0, minko = 0;
    dec.melds.forEach(function(m) {
      if (m.type !== 'koutsu') return;
      if (menzen) anko++; else minko++;
    });
    base += anko * 8 + minko * 4;

    var fu = Math.ceil(base / 10) * 10;
    if (fu < 20) fu = 20;
    return fu;
  }

  function ceil100(n) { return Math.ceil(n / 100) * 100; }
  function kihouten(fu, han) { return fu * Math.pow(2, han + 2); }

  function showResult(main, sub) {
    var box = document.getElementById("result_box");
    box.innerHTML =
      '<div class="result-main">' + main + '</div>' +
      (sub ? '<div class="result-sub">' + sub + '</div>' : '');
  }

  function showError(msg) {
    var box = document.getElementById("result_box");
    box.innerHTML = '<div class="result-error">' + msg + '</div>';
  }

  var pendingAnalysis = null;

  function keisan() {
    var analysis = analyzeHand();
    if (!analysis.ok) {
      showError(analysis.error);
      document.getElementById("detected_yaku_bar").style.display = "none";
      return;
    }
    openYakuModal(analysis);
  }

  function openYakuModal(analysis) {
    pendingAnalysis = {
      han: analysis.han,
      fu: analysis.fu,
      yakuList: analysis.yakuList.slice()
    };
    document.getElementById("ex_riichi").checked = false;
    document.getElementById("ex_daburi").checked = false;
    document.getElementById("ex_ippatsu").checked = false;
    document.getElementById("ex_tsumo").checked = false;
    document.getElementById("ex_tenho").checked = false;
    document.getElementById("ex_chiho").checked = false;
    document.getElementById("yaku_modal").style.display = "flex";
  }

  function closeYakuModal() {
    document.getElementById("yaku_modal").style.display = "none";
    pendingAnalysis = null;
  }

  document.getElementById("modal_cancel").onclick = function() { closeYakuModal(); };

  document.getElementById("modal_ok").onclick = function() {
    if (!pendingAnalysis) return;
    var extraHan = 0;
    var extraNames = [];
    if (document.getElementById("ex_daburi").checked) {
      extraHan += 2;
      extraNames.push("ダブル立直");
    } else if (document.getElementById("ex_riichi").checked) {
      extraHan += 1;
      extraNames.push("立直");
    }
    if (document.getElementById("ex_ippatsu").checked) { extraHan += 1; extraNames.push("一発"); }
    if (document.getElementById("ex_tsumo").checked) { extraHan += 1; extraNames.push("門前清自摸和"); }
    if (document.getElementById("ex_tenho").checked) { extraHan += 13; extraNames.push("天和"); }
    if (document.getElementById("ex_chiho").checked) { extraHan += 13; extraNames.push("地和"); }

    pendingAnalysis.han += extraHan;
    extraNames.forEach(function(n) { pendingAnalysis.yakuList.push({ name: n, han: 0 }); });
    doScoreCalculation(pendingAnalysis);
    closeYakuModal();
  };

  document.getElementById("ex_daburi").onchange = function() {
    var daburi = document.getElementById("ex_daburi").checked;
    document.getElementById("ex_riichi").disabled = daburi;
    if (daburi) document.getElementById("ex_riichi").checked = false;
  };

  function doScoreCalculation(analysis) {
    document.getElementById("han").value = analysis.han;
    document.getElementById("fu").value = analysis.fu;
    var yakuNames = analysis.yakuList.map(function(y) { return y.name; }).join("・");
    document.getElementById("yaku_names").textContent = yakuNames || "役なし";
    document.getElementById("han_display").textContent = analysis.han + "翻";
    document.getElementById("detected_yaku_bar").style.display = "flex";

    var han           = analysis.han;
    var fu            = analysis.fu;
    var honba         = Number(document.getElementById("honba").value) || 0;
    var riichi_ba     = Number(document.getElementById("riichi_ba").value) || 0;
    var riichi_kuyaku = Number(document.getElementById("riichi_kuyaku").value) || 0;
    var isOya         = document.querySelector('input[name="oya"]:checked').value === "oya";
    var agari         = document.querySelector('input[name="agari"]:checked').value;

    var riichiTotal = (riichi_ba + riichi_kuyaku) * 1000;
    var riichiText  = riichiTotal > 0 ? "　供託 +" + riichiTotal + "点" : "";

    if (!han || han < 1) { showError("役がありません"); return; }

    var manganKo       = [8000,  12000, 16000, 24000, 32000];
    var manganOya      = [12000, 18000, 24000, 36000, 48000];
    var manganName     = ["満貫", "跳満", "倍満", "三倍満", "役満"];
    var tsumoKoDetail  = ["親4000・子2000 × 2", "親6000・子3000 × 2", "親8000・子4000 × 2", "親12000・子6000 × 2", "親16000・子8000 × 2"];
    var tsumoOyaDetail = ["子4000 × 3", "子6000 × 3", "子8000 × 3", "子12000 × 3", "子16000 × 3"];

    var manganIdx = -1;
    if      (han >= 13) manganIdx = 4;
    else if (han >= 11) manganIdx = 3;
    else if (han >= 8)  manganIdx = 2;
    else if (han >= 6)  manganIdx = 1;
    else if (han >= 5)  manganIdx = 0;

    if (manganIdx >= 0) {
      var score  = isOya ? manganOya[manganIdx] : manganKo[manganIdx];
      var detail = isOya ? tsumoOyaDetail[manganIdx] : tsumoKoDetail[manganIdx];
      var total  = score + honba * 300 + riichiTotal;
      var sub    = agari === "tsumo" ? detail : "ロン";
      if (honba > 0) sub += "　本場 +" + (honba * 300) + "点";
      sub += riichiText;
      showResult(manganName[manganIdx] + " " + total.toLocaleString() + "点", sub);
      return;
    }

    if (!fu || fu < 20) { showError("符を入力してください"); return; }
    if (isOya && (fu === 20 || fu === 25)) { showError("親に20符・25符は存在しません"); return; }
    if (fu === 20 && agari === "ron")      { showError("20符はツモのみです（ロン不可）"); return; }
    if (fu === 20 && han < 2)             { showError("20符は2翻以上から成立します"); return; }

    var kihon      = kihouten(fu, han);
    var manganLine = isOya ? 12000 : 8000;

    if (agari === "ron") {
      var score = ceil100(kihon * (isOya ? 6 : 4));
      if (score >= manganLine) {
        var total = manganLine + honba * 300 + riichiTotal;
        var sub   = "切り上げ満貫　ロン";
        if (honba > 0) sub += "　本場 +" + (honba * 300) + "点";
        sub += riichiText;
        showResult(total.toLocaleString() + "点", sub);
        return;
      }
      var total = score + honba * 300 + riichiTotal;
      var sub   = fu + "符 " + han + "翻　ロン";
      if (honba > 0) sub += "　本場 +" + (honba * 300) + "点";
      sub += riichiText;
      showResult(total.toLocaleString() + "点", sub);

    } else {
      var score, detail;
      if (isOya) {
        var koPay = ceil100(kihon * 2);
        score  = koPay * 3;
        detail = "子 " + (koPay + honba * 100) + "点 × 3";
      } else {
        var oyaPay = ceil100(kihon * 2);
        var koPay  = ceil100(kihon);
        score  = oyaPay + koPay * 2;
        detail = "親 " + (oyaPay + honba * 100) + "点・子 " + (koPay + honba * 100) + "点 × 2";
      }
      if (score >= manganLine) {
        var mDetail = isOya
          ? "子 " + (manganLine / 3 + honba * 100) + "点 × 3"
          : "親 " + (manganLine / 2 + honba * 100) + "点・子 " + (manganLine / 4 + honba * 100) + "点 × 2";
        var total = manganLine + honba * 300 + riichiTotal;
        var sub   = "切り上げ満貫　" + mDetail + riichiText;
        showResult(total.toLocaleString() + "点", sub);
        return;
      }
      var total = score + honba * 300 + riichiTotal;
      var sub   = fu + "符 " + han + "翻　" + detail + riichiText;
      showResult(total.toLocaleString() + "点", sub);
    }
  }
</script>

</body>
</html>